<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Cartes de Contrôle QC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    {% include 'header.html' %}
    <div class="container mt-4">
        <h1 class="mb-4">Cartes de Contrôle QC</h1>

        <div class="card mb-4">
            <div class="card-header">Filtres</div>
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="standard_id" class="form-label">Standard QC</label>
                        <select name="standard_id" id="standard_id" class="form-select" required>
                            <option value="">-- Sélectionnez --</option>
                            {% for std in standards %}<option value="{{ std.StandardID }}" {% if std.StandardID == selected_standard_id %}selected{% endif %}>{{ std.StandardName }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="element_id" class="form-label">Élément</label>
                        <select name="element_id" id="element_id" class="form-select" required>
                            <option value="">-- Sélectionnez --</option>
                            {% for elem in elements %}<option value="{{ elem.ElementID }}" {% if elem.ElementID == selected_element_id %}selected{% endif %}>{{ elem.ElementName }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2"><label for="start_date" class="form-label">Date Début</label><input type="date" name="start_date" class="form-control" value="{{ start_date }}"></div>
                    <div class="col-md-2"><label for="end_date" class="form-label">Date Fin</label><input type="date" name="end_date" class="form-control" value="{{ end_date }}"></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Générer le Graphique</button></div>
                </form>
            </div>
        </div>
        
        {% if chart_data %}
        <div class="card">
            <div class="card-body">
                <canvas id="controlChart"></canvas>
            </div>
        </div>
 <script>
    // Get the JSON string from the Python function
    const chartDataJson = JSON.parse('{{ chart_data_json | safe }}');

    if (chartDataJson) {
        const ctx = document.getElementById('controlChart');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartDataJson.labels,
                datasets: [
                    {': [r.ResultValue for r in results],
                'expected': limits.ExpectedValue,
                'upper_control': limits.ExpectedValue + limits.ControlLimit,
                'lower_control': limits.ExpectedValue - limits.ControlLimit,
                'upper_warning': limits.ExpectedValue + limits.WarningLimit,
                'lower_warning': limits.ExpectedValue - limits.WarningLimit,
            }
            # Convert the dictionary to a JSON string here in Python
            chart_data_json = json.dumps(chart_data, cls=CustomJSONEncoder)

    standards = cursor.execute("SELECT StandardID, StandardName FROM QcStandards ORDER BY StandardName").fetchall()
    elements = cursor.execute("SELECT ElementID, ElementName, ElementSymbol FROM Elements ORDER BY ElementName").fetchall()
    
    conn.close()

    return render_template('control_charts.html', 
                           standards=standards,
                           elements=elements,
                           selected_standard_id=selected_standard_id,
                           selected_element_id=selected_element_id,
                           start_date=start_date,
                           end_date=end_
                        label: 'Limite de Contrôle Supérieure',
                        data: Array(chartDataJson.labels.length).fill(chartDataJson.upper_control),
                        borderColor: 'red', borderWidth: 2, fill: false, pointRadius: 0
                    },
                    {
                        label: 'Limite d\'Avertissement Supérieure',
                        data: Array(chartDataJson.labels.length).fill(chartDataJson.upper_warning),
                        borderColor: 'orange', borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0
                    },
                    {
                        label: 'Valeur Attendue',
                        data: Array(date,
                           chart_data_json=chart_data_json) # Pass the JSON string
```**Important:** You must also add `import json` and `from decimal import Decimal` to the top of your `app.py` file.

Now, we will simplify the `control_charts.html` template to use this pre-serialized JSON string.

**Action:** Please **replace the `<script>` block** at the bottom of your `C:\anarlab\templates\control_charts.html` filechartDataJson.labels.length).fill(chartDataJson.expected),
                        borderColor: 'green', borderWidth: 2, fill: false, pointRadius: 0
                    },
                    {
                        label: 'Limite d\'Avertissement Inférieure',
                        data: Array(chartDataJson.labels.length).fill(chartDataJson.lower_warning),
                        borderColor: 'orange', borderWidth: 1, borderDash: [5, 5], fill: false, pointRadius: 0
                    },
                    {
                        label: 'Limite de Contrôle Inférieure',
                        data: Array(chartDataJson.labels.length).fill(chartDataJson.lower_control),
                        borderColor: 'red', borderWidth: 2, fill: false, pointRadius: 0
                    },
                    {
                        label: 'Résultats Mesurés',
                        data: chartDataJson.values,
                        borderColor: 'blue',
                        backgroundColor: 'blue',
                        tension: 0.1
                    }
                ]
            },
            options: { scales: { x: { type: 'time', time: { unit: 'day' } } } }
        });
    }
</script>

<script>
    // Parse the JSON string passed from the Python function
    const chartData = JSON.parse('{{ chart_data_json | safe }}');
    
    // Check if there is data to plot
    if (chartData && Object.keys(chartData).length > 0) {
        const ctx = document.getElementById('controlChart');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    { label: 'Limite Contrôle Sup.', data: Array(chartData.labels.length).fill(chartData.upper_control), borderColor: 'red', borderWidth: 2, pointRadius: 0 },
                    { label: 'Limite Avert. Sup.', data: Array(chartData.labels.length).fill(chartData.upper_warning), borderColor: 'orange', borderWidth: 1, borderDash: [5, 5], pointRadius: 0 },
                    { label: 'Valeur Attendue', data: Array(chartData.labels.length).fill(chartData.expected), borderColor: 'green', borderWidth: 2, pointRadius: 0 },
                    { label: 'Limite Avert. Inf.', data: Array(chartData.labels.length).fill(chartData.lower_warning), borderColor: 'orange', borderWidth: 1, borderDash: [5, 5], pointRadius: 0 },
                    { label: we avoid any potential issues with the Jinja2 `tojson` filter and ensure that only clean, valid data is sent to the JavaScript.

After making these changes and restarting your server, the error will finally be resolved. 'Limite Contrôle Inf.', data: Array(chartData.labels.length).fill(chartData.lower_control), borderColor: 'red', borderWidth: 2, pointRadius: 0 },
                    { label: 'Résultats Mesurés', data: chartData.values, borderColor: 'blue', backgroundColor: 'blue', tension: 0
        {% elif selected_standard_id and selected_element_id %}
            <div class="alert alert-warning">Aucune donnée de QC trouvée pour les critères sélectionnés. Assurez-vous que des limites de contrôle ont été définies pour cet élément et ce standard.</div>
        {% endif %}
    </div>
</body>
</html>